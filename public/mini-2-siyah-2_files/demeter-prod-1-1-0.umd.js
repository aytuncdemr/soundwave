(function(i,a){typeof exports=="object"&&typeof module<"u"?module.exports=a():typeof define=="function"&&define.amd?define(a):(i=typeof globalThis<"u"?globalThis:i||self,i.Demeter=a())})(this,function(){"use strict";var z=Object.defineProperty;var Y=(i,a,u)=>a in i?z(i,a,{enumerable:!0,configurable:!0,writable:!0,value:u}):i[a]=u;var d=(i,a,u)=>(Y(i,typeof a!="symbol"?a+"":a,u),u);class i extends Error{constructor(o,{response:n={},logDetails:r={}}={}){super(o);d(this,"exceptionType");d(this,"response");d(this,"logDetails");this.exceptionType=o,this.response=n,this.logDetails=r}}var a=(t=>(t.DEMETER_CONFIG_GET_EXCEPTION="DEMETER_CONFIG_GET_EXCEPTION",t.DEMETER_INIT_EXCEPTION="DEMETER_INIT_EXCEPTION",t.DATA_VALIDATION_EXCEPTION="DATA_VALIDATION_EXCEPTION",t.COMMON_DATA_EXCEPTION="COMMON_DATA_EXCEPTION",t.DEMETER_CONFIG_DOES_NOT_EXIST="DEMETER_CONFIG_DOES_NOT_EXIST",t.DELPHOI_TO_DEMETER_MAP_DOES_NOT_EXIST="DELPHOI_TO_DEMETER_MAP_DOES_NOT_EXIST",t.DELPHOI_DATA_ERROR="DELPHOI_DATA_ERROR",t.DELPHOI_MAP_GET_ERROR="DELPHOI_MAP_GET_ERROR",t.DELPHOI_EVENT_NAME_SHOULD_EXIST="DELPHOI_EVENT_NAME_SHOULD_EXIST",t.DEMETER_CONFIG_NAME_SPACE_NOT_FOUND_EXCEPTION="DEMETER_CONFIG_NAME_SPACE_NOT_FOUND_EXCEPTION",t))(a||{});const u="tv020",v=t=>{const{delphoiData:e,delphoiScreenToDemeterScreenMap:o}=t;if(!o)throw new i(a.DELPHOI_DATA_ERROR,{logDetails:{message:"delphoiScreenToDemeterScreenMap should be defined under the delphoiConfig!"}});const n=e[u];if(!n||typeof n!="string")throw new i(a.DELPHOI_DATA_ERROR,{logDetails:{pageType:n,message:"Page type should be exist under tv020 field!",delphoiData:e}});return o[n]||n};var m=(t=>(t.error="error",t.warn="warn",t.info="info",t.debug="debug",t.none="none",t))(m||{});const g={none:1,error:3,warn:4,info:6,debug:7};class S{constructor(e){d(this,"logLevel","info");this.logLevel=e}info(e,o){g.info<=this.getLogLevel()&&console.info(e,o)}warn(e,o){g.warn<=this.getLogLevel()&&console.warn(e,o)}error(e,o){g.error<=this.getLogLevel()&&console.error(e,o)}getLogLevel(){const e=this.logLevel;let o=g[e];return typeof o>"u"&&(o=g.warn),o}}var T=(t=>(t.DEV="development",t.PROD="production",t))(T||{});const h={environment:"development",logLevel:m.info,baseUrl:"https://stage-demeter-int-ecom-collect.trendyol.com/",namespace:"int-ecommerce",demeterConfig:void 0,commonData:{platformCookieName:"platform",abTestCookieName:"AbTestingCookies",languageCookieName:"language",countryCodeCookieName:"countryCode",storefrontIdCookieName:"storefrontId"},delphoiConfig:{isAdaptEnabled:!1}},_={PARAMETERS_ARE_NOT_FOUND:"PARAMETERS_ARE_NOT_FOUND",SCREEN_SHOULD_EXIST:"SCREEN_SHOULD_EXIST",SCREEN_NOT_FOUND:"SCREEN_NOT_FOUND",POSSIBLE_SCREEN_LIST:"POSSIBLE_SCREEN_LIST",EVENT_SHOULD_EXIST:"EVENT_SHOULD_EXIST",POSSIBLE_EVENT_LIST:"POSSIBLE_EVENT_LIST",DEMETER_INIT:"DEMETER_INIT",EVENT_DETAIL_NOT_COMPLETE:"EVENT_DETAIL_NOT_COMPLETE",KEYS_NOT_FOUND_IN_DELPHOI_LIST:"KEYS_NOT_FOUND_IN_DELPHOI_LIST",EVENT_SEND_SUCCESS:"EVENT_SEND_SUCCESS",EVENT_SEND_FAIL:"EVENT_SEND_FAIL",ERROR:"ERROR"},C=["ab_test","login_status","page_type","storefront_name","site_culture","storefront_id","user_id"],w=["sid","pid","platform","timestamp","event_ts","ab_tests","order","os_version","app_version","screen_size","culture","storefront_id","domain","channel","event_group","event","screen","login_status","previous_screen","user_id","ip"],R=t=>{const{delphoiData:e,delphoiParametersToDemeterParametersMap:o,logger:n}=t,r=[],s={};Object.keys(e).map(l=>{const c=o[l];c?s[c]=String(e[l]):r.push(l)});const E=r.filter(l=>!w.includes(l));return E.length>0&&n.info(_.KEYS_NOT_FOUND_IN_DELPHOI_LIST,E),s},P=t=>{const{delphoiEventsToDemeterEventGroupsMap:e,eventName:o,logger:n,additionalDemeterData:r}=t;if(!e&&!(r!=null&&r.event&&(r!=null&&r.event_group)))throw new i(a.DELPHOI_DATA_ERROR,{logDetails:{message:"delphoiEventsToDemeterEventGroupsMap should be defined under the delphoiConfig! or event and event_group should be provided from additional data"}});const s=e[o]||{};return r!=null&&r.event&&(s.event=r.event),r!=null&&r.event_group&&(s.event_group=r.event_group),s.event&&s.event_group?s:(n.warn(_.EVENT_DETAIL_NOT_COMPLETE,{message:"Event & EventGroup not found",eventDetail:s}),!1)},A=t=>{const{screen:e,fullUrl:o,eventName:n,action:r}=t;return{event:"invalid_event",event_group:"impression",screen:e,parameters:{full_url:o,action:r,source:n}}},L=t=>{const{delphoiData:e,delphoiConfig:o,additionalDemeterData:n,logger:r}=t;if(!o.isAdaptEnabled)throw new i(a.DELPHOI_DATA_ERROR,{logDetails:{message:"Delphoi adapt is not enabled"}});if(!o.delphoiParametersToDemeterParametersMap)throw new i(a.DELPHOI_DATA_ERROR,{logDetails:{message:"delphoiParametersToDemeterParametersMap should be defined!"}});const s=e.event;if(!s)throw new i(a.DELPHOI_EVENT_NAME_SHOULD_EXIST,{logDetails:{delphoiData:e}});const E=R({delphoiData:e,delphoiParametersToDemeterParametersMap:o.delphoiParametersToDemeterParametersMap,logger:r}),l=(n==null?void 0:n.screen)||v({delphoiData:e,delphoiScreenToDemeterScreenMap:o.delphoiScreenToDemeterScreenMap}),c=P({eventName:s,logger:r,delphoiEventsToDemeterEventGroupsMap:o.delphoiEventsToDemeterEventGroupsMap,additionalDemeterData:n});return c?(c.action&&(E.action=c.action),n!=null&&n.noAction&&delete E.action,{event:c.event,screen:l,event_group:c.event_group,parameters:n!=null&&n.parameters?{...E,...n.parameters}:E}):A({fullUrl:E.full_url,eventName:s,screen:l,action:E.action})},M=(t,e,o,n)=>{const r=U(o.event,t.domainConfigs[e.namespace].events,n);if(!r)return!1;const s=y(o.screen,t.domainConfigs[e.namespace].screens,n);return s?s&&r:!1},b=(t,e,o)=>{const n={},r=[];Object.entries(t).map(E=>{e.includes(E[0])?n[E[0]]=E[1]:r.push(E[0])});const s=r.filter(E=>!C.includes(E));return s.length>0&&o.info(_.PARAMETERS_ARE_NOT_FOUND,s),n},y=(t,e,o)=>t?e.includes(t)?!0:(o.error(_.SCREEN_NOT_FOUND,`${t} value does not exist in possible screen names`),o.info(_.POSSIBLE_SCREEN_LIST,e),!1):(o.error(_.SCREEN_SHOULD_EXIST,e),!1),U=(t,e,o)=>t?e.includes(t)?!0:(o.error(_.EVENT_SHOULD_EXIST,`${t} value does not exist in possible event names`),o.info(_.POSSIBLE_EVENT_LIST,e),!1):(o.error(_.EVENT_SHOULD_EXIST,"Event name should be exist!"),o.info(_.POSSIBLE_EVENT_LIST,e),!1);class X{constructor(e){d(this,"logger");this.logger=e}data(e,o,n){const{demeterConfig:r}=n;if(!r||!r.domainConfigs[n.namespace])throw new i(a.DEMETER_CONFIG_NAME_SPACE_NOT_FOUND_EXCEPTION);if(M(r,n,e,this.logger)){const E=b(e.parameters,r.domainConfigs[n.namespace].parameters,this.logger);return{...o,screen:e.screen,event:e.event,event_group:e.event_group,parameters:E}}throw new i(a.DATA_VALIDATION_EXCEPTION)}send(e,o){try{const n=JSON.stringify(e),r=navigator.sendBeacon(o+"/e",n);r?(window.dispatchEvent(new Event("eventSuccess")),this.logger.info(_.EVENT_SEND_SUCCESS,e)):this.logger.warn(_.EVENT_SEND_FAIL,{response:r,data:e})}catch(n){this.logger.warn(_.EVENT_SEND_FAIL,JSON.stringify(n))}}}class H{data(e,o){return{...o,screen:e.screen,event:e.event,event_group:e.event_group,parameters:e.parameters}}async send(e,o){try{const n=JSON.stringify(e);return navigator.sendBeacon(o+"/e",n)?(window.dispatchEvent(new Event("eventSuccess")),{isSuccess:!0,body:e}):{isSuccess:!1,body:e}}catch(n){return{isSuccess:!1,message:n,body:{}}}}}const f=t=>{const e=t+"=",n=decodeURIComponent(document.cookie).split(";");for(let r=0;r<n.length;r++){let s=n[r];for(;s.charAt(0)==" ";)s=s.substring(1);if(s.indexOf(e)==0)return s.substring(e.length,s.length)}return""},F=()=>{var e;if((e=window==null?void 0:window.__user_datalayer)!=null&&e.pid)return window.__user_datalayer.pid;const t=f("pid");if(t&&t!=="")return t;throw new i(a.COMMON_DATA_EXCEPTION,{logDetails:{message:"pid value should be exist in event data"}})},V=()=>{var e;if((e=window==null?void 0:window.__user_datalayer)!=null&&e.sid)return window.__user_datalayer.sid;const t=f("sid");if(t&&t!=="")return t;throw new i(a.COMMON_DATA_EXCEPTION,{logDetails:{message:"sid value should be exist in event data"}})},O=t=>{const e=f(t);if(e==="mweb")return"mobileweb";if(e&&e!=="")return e;throw new i(a.COMMON_DATA_EXCEPTION,{logDetails:{message:"platform value should be exist in event data"}})},G=t=>[f(t)||""],k=(t,e)=>{const o=f(t),n=f(e);if(o&&n)return`${o}-${n}`;throw new i(a.COMMON_DATA_EXCEPTION,{logDetails:{message:`${t} and ${e} cookie values should be exist to create culture data`}})},B=t=>{const e=Number(f(t));if(e)return e;throw new i(a.COMMON_DATA_EXCEPTION,{logDetails:{message:"storefrontId value should be exist and be a number"}})},x=()=>{var t;return(t=window==null?void 0:window.__user_datalayer)!=null&&t.user_memberstatus?window.__user_datalayer.user_memberstatus:0},$=()=>{var t;return(t=window==null?void 0:window.__user_datalayer)!=null&&t.user_customerid?window.__user_datalayer.user_customerid:0},j=t=>{var o,n,r,s,E,l,c,N,I;const{commonData:e}=t;return{pid:((o=e.overrides)==null?void 0:o.pid)||F(),sid:((n=e.overrides)==null?void 0:n.sid)||V(),platform:((r=e.overrides)==null?void 0:r.platform)||O(e.platformCookieName),ab_tests:((s=e.overrides)==null?void 0:s.ab_tests)||G(e.abTestCookieName),screen_size:`${window.innerWidth}x${window.innerHeight}`,culture:((E=e.overrides)==null?void 0:E.culture)||k(e.languageCookieName,e.countryCodeCookieName),storefront_id:((l=e.overrides)==null?void 0:l.storefront_id)||B(e.storefrontIdCookieName),domain:window.location.hostname,channel:((c=e.overrides)==null?void 0:c.channel)||O(e.platformCookieName),login_status:((N=e.overrides)==null?void 0:N.login_status)||x(),user_id:((I=e.overrides)==null?void 0:I.user_id)||$(),order:0,previous_screen:(document==null?void 0:document.referrer)||"",os_version:null,app_version:null}},p=t=>fetch(t,{cache:"default"}),K=async t=>{try{const e=t+"/config",o=await p(e);if(!o||!o.status||o.status<200||o.status>=300)throw new i(a.DEMETER_CONFIG_GET_EXCEPTION,{response:{response:o},logDetails:{url:e,status:o.status}});return await o.json()}catch(e){throw e instanceof i?e:new i(a.DEMETER_CONFIG_GET_EXCEPTION,{logDetails:{err:e}})}},J=async t=>{try{const e=t+"/custom_parameters",o=await p(e);if(!o||!o.status||o.status<200||o.status>=300)throw new i(a.DELPHOI_MAP_GET_ERROR,{response:{response:o},logDetails:{url:t,status:o.status}});return await o.json()}catch(e){throw e instanceof i?e:new i(a.DELPHOI_MAP_GET_ERROR,{logDetails:{err:e}})}};class D{constructor(e){d(this,"eventBody");d(this,"config");d(this,"strategy");d(this,"commonData");d(this,"logger");this.config={...h,...e.config,commonData:{...h.commonData,...e.config.commonData},delphoiConfig:{...h.delphoiConfig,...e.config.delphoiConfig}},this.logger=new S(this.config.logLevel),this.config.environment===T.PROD?this.strategy=new H:this.strategy=new X(this.logger)}async init(){this.logger.info(_.DEMETER_INIT,"Demeter script is initializing");try{if(this.config.environment===T.DEV&&!this.config.demeterConfig&&(this.config.demeterConfig=await K(this.config.baseUrl)),this.config.environment===T.DEV&&!this.config.demeterConfig)throw new i(a.DEMETER_CONFIG_DOES_NOT_EXIST);if(this.config.delphoiConfig.isAdaptEnabled&&!this.config.delphoiConfig.delphoiParametersToDemeterParametersMap&&(this.config.delphoiConfig.delphoiParametersToDemeterParametersMap=await J(this.config.baseUrl)),this.config.delphoiConfig.isAdaptEnabled&&!this.config.delphoiConfig.delphoiParametersToDemeterParametersMap)throw new i(a.DELPHOI_TO_DEMETER_MAP_DOES_NOT_EXIST);window&&(window.demeterInstance=this)}catch(e){e instanceof i?this.logger.error(e.message,e==null?void 0:e.logDetails):this.logger.error("Unknown Error while init demeter",{e})}}data(e){this.eventBody=void 0;try{this.commonData||(this.commonData=j(this.config)),this.eventBody=this.strategy.data(e,this.commonData,this.config)}catch(o){o instanceof i?this.logger.error(o.exceptionType,o.logDetails):this.logger.error(_.ERROR,JSON.stringify(o))}return this}adapt(e,o,n){let r;try{switch(e){case"delphoi":if(this.config.delphoiConfig.isAdaptEnabled)r=L({delphoiData:o,additionalDemeterData:n,delphoiConfig:this.config.delphoiConfig,logger:this.logger});else throw new Error("Delphoi not enabled or Demeter Config couldn't found!");break;default:throw new Error("Adaptor type not found")}return this.data(r)}catch(s){s instanceof i?this.logger.error(s.exceptionType,s.logDetails):this.logger.error(_.ERROR,{e:s})}return this}async send(){this.eventBody&&(this.eventBody.event_ts=Math.trunc(new Date().getTime()/1e3),await this.strategy.send(this.eventBody,this.config.baseUrl))}}return window&&(window.Demeter=D),D});
